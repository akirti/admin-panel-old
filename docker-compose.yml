version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: easylife-mongodb
    restart: unless-stopped
    command: mongod --auth --bind_ip_all --setParameter diagnosticDataCollectionEnabled=false
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-password123}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-easylife_auth}
    volumes:
      - mongodb_data:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d:ro
    ports:
      - "${MONGO_PORT:-27017}:27017"
    networks:
      - easylife-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    mem_swappiness: 60
    memswap_limit: 2G
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Backend API (FastAPI)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: easylife-backend
    restart: unless-stopped
    stop_grace_period: 10s
    env_file:
      - ./backend/.env
    environment:
      # Database - simplified env vars
      MONGODB_SCHEME: mongodb
      MONGODB_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGODB_PASSWORD: ${MONGO_ROOT_PASSWORD:-password123}
      MONGODB_HOST: mongodb:27017
      MONGODB_DATABASE: ${MONGO_DATABASE:-easylife_auth}
      # Auth
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-super-secret-jwt-key-change-in-production}
      EASYLIFE_SPECS_AUTH_TOKEN_TIMEOUT: ${TOKEN_TIMEOUT:-30}
      # SMTP (optional)
      SMTP_SERVER: ${SMTP_SERVER:-mailpit}
      SMTP_PORT: ${SMTP_PORT:-1025}
      SMTP_EMAIL: ${SMTP_EMAIL:-noreply@easylife.local}
      # App
      WEBAPP_HOST: ${WEBAPP_HOST:-http://localhost:3000/}
      # CORS_ORIGINS is loaded from backend/.env file via env_file
      ENVIRONMENT: ${ENVIRONMENT:-production}
      # File Storage Configuration
      # FILE_STORAGE_TYPE: "gcs" or "local" (default: local)
      FILE_STORAGE_TYPE: ${FILE_STORAGE_TYPE:-local}
      LOCAL_UPLOAD_PATH: ${LOCAL_UPLOAD_PATH:-/tmp/easylife_uploads}
      # GCS Configuration (required if FILE_STORAGE_TYPE=gcs)
      GCS_CREDENTIALS_JSON: ${GCS_CREDENTIALS_JSON:-}
      GCS_BUCKET_NAME: ${GCS_BUCKET_NAME:-}
      # Jira Integration (optional)
      JIRA_BASE_URL: ${JIRA_BASE_URL:-}
      JIRA_EMAIL: ${JIRA_EMAIL:-}
      JIRA_API_TOKEN: ${JIRA_API_TOKEN:-}
      JIRA_PROJECT_KEY: ${JIRA_PROJECT_KEY:-SCEN}
      JIRA_ISSUE_TYPE: ${JIRA_ISSUE_TYPE:-Task}
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - easylife-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    mem_swappiness: 60
    memswap_limit: 2G
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; r=urllib.request.urlopen('http://localhost:8000/api/v1/health/ready', timeout=10); exit(0 if b'ready' in r.read() else 1)"]
      interval: 15s
      timeout: 15s
      retries: 3
      start_period: 20s

  # Frontend - Admin Panel (React + Nginx)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: easylife-frontend
    restart: unless-stopped
    stop_grace_period: 5s
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    depends_on:
      - backend
    networks:
      - easylife-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 256M
    mem_swappiness: 60
    memswap_limit: 2G
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # EasyLife Dashboard (React + Nginx)
  easylife-dashboard:
    build:
      context: ./easylife-dashboard
      dockerfile: Dockerfile
    container_name: easylife-dashboard
    restart: unless-stopped
    stop_grace_period: 5s
    ports:
      - "${DASHBOARD_PORT:-3001}:80"
    depends_on:
      - backend
    networks:
      - easylife-network
    environment:
      # Runtime environment config (can be overridden)
      - MFE_BASE_URL=${MFE_BASE_URL:-http://localhost:3000/}
      - APIGEE_BASE_URL=${APIGEE_BASE_URL:-http://localhost:8000}
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    mem_swappiness: 60
    memswap_limit: 1G
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Mailpit - Email testing (optional, for development)
  mailpit:
    image: axllent/mailpit:latest
    container_name: easylife-mailpit
    restart: unless-stopped
    ports:
      - "${MAILPIT_SMTP_PORT:-1025}:1025"  # SMTP
      - "${MAILPIT_WEB_PORT:-8025}:8025"   # Web UI
    environment:
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    networks:
      - easylife-network

  # Mongo Express - Database UI (optional, for development)
  mongo-express:
    image: mongo-express:latest
    container_name: easylife-mongo-express
    restart: unless-stopped
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGO_ROOT_USERNAME:-admin}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_ROOT_PASSWORD:-password123}
      ME_CONFIG_MONGODB_URL: mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-password123}@mongodb:27017/
      ME_CONFIG_BASICAUTH_USERNAME: ${MONGO_EXPRESS_USERNAME:-admin}
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGO_EXPRESS_PASSWORD:-admin123}
    ports:
      - "${MONGO_EXPRESS_PORT:-8081}:8081"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - easylife-network
    profiles:
      - dev

networks:
  easylife-network:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1400

volumes:
  mongodb_data:
    driver: local
